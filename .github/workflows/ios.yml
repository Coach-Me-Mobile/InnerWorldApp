name: iOS CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      deploy_to_testflight:
        description: 'Deploy to TestFlight'
        required: false
        default: false
        type: boolean

jobs:
  build:
    name: Build iOS App
    runs-on: macos-14
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.1'
      
      - name: Build
        run: |
          cd ios
          xcodebuild \
            -project InnerWorld.xcodeproj \
            -scheme InnerWorld \
            -destination "generic/platform=iOS" \
            -configuration Debug \
            CODE_SIGNING_ALLOWED=NO \
            build

  deploy:
    name: Deploy to TestFlight
    runs-on: macos-14
    needs: build
    if: github.ref == 'refs/heads/main' || github.event.inputs.deploy_to_testflight == 'true'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.1'
      
      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
      
      - name: Check deployment trigger
        run: |
          if [ "${{ github.event.inputs.deploy_to_testflight }}" == "true" ]; then
            echo "üöÄ Manual TestFlight deployment triggered"
          else
            echo "üîÑ Automatic TestFlight deployment (main branch)"
          fi
      
      - name: Get Apple credentials
        run: |
          # Get Apple Team ID
          APPLE_SECRETS=$(aws secretsmanager get-secret-value \
            --secret-id "innerworld-prod/apple/signin-key" \
            --query SecretString --output text)
          APPLE_TEAM_ID=$(echo "$APPLE_SECRETS" | jq -r '.team_id')
          
          echo "üîç Retrieved Apple Team ID: $APPLE_TEAM_ID"
          echo "APPLE_TEAM_ID=$APPLE_TEAM_ID" >> $GITHUB_ENV
          
          # Get App Store Connect API key
          ASC_SECRETS=$(aws secretsmanager get-secret-value \
            --secret-id "innerworld-prod/appstoreconnect/api-key" \
            --query SecretString --output text)
          
          ASC_KEY_ID=$(echo "$ASC_SECRETS" | jq -r '.key_id')
          ASC_ISSUER_ID=$(echo "$ASC_SECRETS" | jq -r '.issuer_id')
          
          echo "üîë App Store Connect Key ID: $ASC_KEY_ID"
          echo "üè¢ App Store Connect Issuer ID: $ASC_ISSUER_ID"
          
          mkdir -p ~/.appstoreconnect/private_keys
          echo "$ASC_SECRETS" | jq -r '.private_key' > ~/.appstoreconnect/private_keys/AuthKey_${ASC_KEY_ID}.p8
          
          echo "ASC_KEY_ID=$ASC_KEY_ID" >> $GITHUB_ENV
          echo "ASC_ISSUER_ID=$ASC_ISSUER_ID" >> $GITHUB_ENV
      
      - name: Import Apple certificates
        run: |
          echo "üîê Setting up code signing..."
          
          # Create temporary keychain
          security create-keychain -p "" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "" build.keychain
          security set-keychain-settings -t 3600 -u build.keychain
          
          # Import certificate if available
          if [ -n "${{ secrets.APPLE_CERTIFICATE_P12_BASE64 }}" ]; then
            echo "üì± Importing Apple Developer certificate..."
            echo "${{ secrets.APPLE_CERTIFICATE_P12_BASE64 }}" | base64 --decode > certificate.p12
            security import certificate.p12 -k build.keychain -P "${{ secrets.APPLE_CERTIFICATE_PASSWORD }}" -T /usr/bin/codesign
            security set-key-partition-list -S apple-tool:,apple: -s -k "" build.keychain
            echo "‚úÖ Certificate imported"
          else
            echo "‚ö†Ô∏è  No certificate found - will build without signing"
          fi
          
          # Install provisioning profile if available
          if [ -n "${{ secrets.APPLE_PROVISIONING_PROFILE_BASE64 }}" ]; then
            echo "üìã Installing provisioning profile..."
            mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
            echo "${{ secrets.APPLE_PROVISIONING_PROFILE_BASE64 }}" | base64 --decode > ~/Library/MobileDevice/Provisioning\ Profiles/InnerWorld.mobileprovision
            echo "‚úÖ Provisioning profile installed"
          else
            echo "‚ö†Ô∏è  No provisioning profile found"
          fi
      
      - name: Build and archive for TestFlight
        run: |
          cd ios
          
          # Build version info
          BUILD_NUMBER="${GITHUB_SHA:0:8}"
          VERSION_NUMBER="$(date '+%Y.%m.%d')"
          
          echo "üì± Building iOS app..."
          echo "Team ID: $APPLE_TEAM_ID"
          echo "Build: $BUILD_NUMBER"
          echo "Version: $VERSION_NUMBER"
          
          # Determine if we can code sign
          if [ -n "${{ secrets.APPLE_CERTIFICATE_P12_BASE64 }}" ] && [ -n "${{ secrets.APPLE_PROVISIONING_PROFILE_BASE64 }}" ]; then
            echo "üîê Building with code signing..."
            
            # Archive with code signing
            xcodebuild \
              -project InnerWorld.xcodeproj \
              -scheme InnerWorld \
              -destination "generic/platform=iOS" \
              -configuration Release \
              -archivePath InnerWorld.xcarchive \
              MARKETING_VERSION="$VERSION_NUMBER" \
              CURRENT_PROJECT_VERSION="$BUILD_NUMBER" \
              CODE_SIGN_STYLE=Manual \
              DEVELOPMENT_TEAM="$APPLE_TEAM_ID" \
              PROVISIONING_PROFILE_SPECIFIER="InnerWorld" \
              archive
            
            # Export IPA
            echo "üì¶ Creating export options..."
            cat > ExportOptions.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>app-store</string>
              <key>teamID</key>
              <string>$APPLE_TEAM_ID</string>
          </dict>
          </plist>
          EOF
            
            echo "üì§ Exporting archive to IPA..."
            xcodebuild \
              -exportArchive \
              -archivePath InnerWorld.xcarchive \
              -exportPath export \
              -exportOptionsPlist ExportOptions.plist
            
            # Upload to TestFlight
            echo "üöÄ Uploading to TestFlight..."
            xcrun altool --upload-app \
              --type ios \
              --file export/InnerWorld.ipa \
              --apiKey "$ASC_KEY_ID" \
              --apiIssuer "$ASC_ISSUER_ID" \
              --verbose
            
            echo "‚úÖ Deployed to TestFlight: Build $BUILD_NUMBER, Version $VERSION_NUMBER"
            
          else
            echo "‚ö†Ô∏è  Missing certificates - building without code signing for verification..."
            
            # Build without code signing
            xcodebuild \
              -project InnerWorld.xcodeproj \
              -scheme InnerWorld \
              -destination "generic/platform=iOS" \
              -configuration Release \
              MARKETING_VERSION="$VERSION_NUMBER" \
              CURRENT_PROJECT_VERSION="$BUILD_NUMBER" \
              CODE_SIGNING_ALLOWED=NO \
              build
            
            echo "‚úÖ iOS app builds successfully!"
            echo "üìã To enable TestFlight deployment, add these GitHub secrets:"
            echo "   - APPLE_CERTIFICATE_P12_BASE64"
            echo "   - APPLE_CERTIFICATE_PASSWORD"
            echo "   - APPLE_PROVISIONING_PROFILE_BASE64"
          fi
      
      - name: Cleanup keychain
        if: always()
        run: |
          security delete-keychain build.keychain || true
